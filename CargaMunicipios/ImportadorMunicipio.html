<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Importar Munic√≠pios para Firestore</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        #progresso-container {
            width: 100%;
            background: #eee;
            border-radius: 6px;
            margin-top: 20px;
        }

        #progresso-barra {
            height: 24px;
            width: 0%;
            background: #007acc;
            color: white;
            text-align: center;
            line-height: 24px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <h2>üì• Importar Munic√≠pios para Firestore</h2>
    <p>Selecione o arquivo <strong>municipios.json</strong> com os dados do IBGE:</p>
    <input type="file" id="upload-json" accept=".json">
    <div id="progresso-container">
        <div id="progresso-barra">0%</div>
    </div>
    <p id="status" style="margin-top:10px;font-weight:bold;"></p>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDcS4nneXnN8Cdb-S_cQukwaguLXJYbQ1U",
            authDomain: "radarsiope.firebaseapp.com",
            projectId: "radarsiope"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const mapaUF = {
            11: { sigla: "RO", nome: "Rond√¥nia", regiao: "Norte" },
            12: { sigla: "AC", nome: "Acre", regiao: "Norte" },
            13: { sigla: "AM", nome: "Amazonas", regiao: "Norte" },
            14: { sigla: "RR", nome: "Roraima", regiao: "Norte" },
            15: { sigla: "PA", nome: "Par√°", regiao: "Norte" },
            16: { sigla: "AP", nome: "Amap√°", regiao: "Norte" },
            17: { sigla: "TO", nome: "Tocantins", regiao: "Norte" },
            21: { sigla: "MA", nome: "Maranh√£o", regiao: "Nordeste" },
            22: { sigla: "PI", nome: "Piau√≠", regiao: "Nordeste" },
            23: { sigla: "CE", nome: "Cear√°", regiao: "Nordeste" },
            24: { sigla: "RN", nome: "Rio Grande do Norte", regiao: "Nordeste" },
            25: { sigla: "PB", nome: "Para√≠ba", regiao: "Nordeste" },
            26: { sigla: "PE", nome: "Pernambuco", regiao: "Nordeste" },
            27: { sigla: "AL", nome: "Alagoas", regiao: "Nordeste" },
            28: { sigla: "SE", nome: "Sergipe", regiao: "Nordeste" },
            29: { sigla: "BA", nome: "Bahia", regiao: "Nordeste" },
            31: { sigla: "MG", nome: "Minas Gerais", regiao: "Sudeste" },
            32: { sigla: "ES", nome: "Esp√≠rito Santo", regiao: "Sudeste" },
            33: { sigla: "RJ", nome: "Rio de Janeiro", regiao: "Sudeste" },
            35: { sigla: "SP", nome: "S√£o Paulo", regiao: "Sudeste" },
            41: { sigla: "PR", nome: "Paran√°", regiao: "Sul" },
            42: { sigla: "SC", nome: "Santa Catarina", regiao: "Sul" },
            43: { sigla: "RS", nome: "Rio Grande do Sul", regiao: "Sul" },
            50: { sigla: "MS", nome: "Mato Grosso do Sul", regiao: "Centro-Oeste" },
            51: { sigla: "MT", nome: "Mato Grosso", regiao: "Centro-Oeste" },
            52: { sigla: "GO", nome: "Goi√°s", regiao: "Centro-Oeste" },
            53: { sigla: "DF", nome: "Distrito Federal", regiao: "Centro-Oeste" }
        };

        async function limparColecaoUF() {
            const ufSnap = await db.collection("UF").get();
            for (const doc of ufSnap.docs) {
                console.log("üîÑ Limpando UF:", doc.id);
                const ufRef = db.collection("UF").doc(doc.id);
                const municipiosSnap = await ufRef.collection("Municipio").get();
                for (const mDoc of municipiosSnap.docs) {
                    await ufRef.collection("Municipio").doc(mDoc.id).delete();
                }
                await ufRef.delete();
            }
        }

        async function importarMunicipios(municipiosJson) {
            const status = document.getElementById("status");
            const barra = document.getElementById("progresso-barra");
            const agrupados = {};

            for (const m of municipiosJson) {
                const ufInfo = mapaUF[m.codigo_uf];
                if (!ufInfo) continue;

                if (!agrupados[ufInfo.sigla]) {
                    agrupados[ufInfo.sigla] = {
                        cod_uf: m.codigo_uf,
                        nome_uf: ufInfo.nome,
                        regiao: ufInfo.regiao,
                        listaMunicipios: []
                    };
                }

                agrupados[ufInfo.sigla].listaMunicipios.push({
                    cod_municipio: m.codigo_ibge,
                    nome_municipio: m.nome
                });
            }

            const totalMunicipios = Object.values(agrupados).reduce((acc, uf) => acc + uf.listaMunicipios.length, 0);
            let gravados = 0;

            let gravados = 0;
            const limiteTotal = 10;

            for (const siglaUF in agrupados) {
                const { cod_uf, nome_uf, regiao, listaMunicipios } = agrupados[siglaUF];
                const ufRef = db.collection("UF").doc(siglaUF);
                
                await ufRef.set({ cod_uf, nome_uf, regiao });

                for (const municipio of listaMunicipios) {
                    if (gravados >= limiteTotal) break;

                    console.log("üîç Dados do munic√≠pio:", JSON.stringify(municipio));

                    await ufRef.collection("Municipio").doc(String(municipio.cod_municipio)).set({
                        cod_municipio: municipio.cod_municipio,
                        nome_municipio: municipio.nome_municipio
                    });

                    console.log("‚úÖ Gravado:", municipio.cod_municipio, municipio.nome_municipio);

                    gravados++;
                    const progresso = Math.round((gravados / limiteTotal) * 100);
                    barra.style.width = progresso + "%";
                    barra.textContent = progresso + "%";
                }

                if (gravados >= limiteTotal) break;
            }
            status.innerText = "‚úÖ Importa√ß√£o conclu√≠da com sucesso!";
        }

        document.getElementById("upload-json").addEventListener("change", async function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function (event) {
                console.log("üìÇ Arquivo carregado, iniciando parse...");

                try {

                    const municipiosJson = JSON.parse(event.target.result);
                    document.getElementById("status").innerText = "üßπ Limpando dados existentes...";
                    console.log("üßπ Iniciando limpeza da cole√ß√£o UF...");

                    await limparColecaoUF();
                    document.getElementById("status").innerText = "üì¶ Importando novos dados...";
                    await importarMunicipios(municipiosJson);
                    console.log("‚úÖ Importa√ß√£o finalizada.");

                } catch (err) {
                    document.getElementById("status").innerText = "‚ùå Erro ao processar o arquivo.";
                    console.error("‚ùå Erro detectado:", err);
                }
            };
            reader.readAsText(file);
        });
    </script>
</body>

</html>