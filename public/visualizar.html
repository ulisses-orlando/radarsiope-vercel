<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Visualizar Newsletter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    .top-bar {
      text-align: center;
      padding: 20px;
      background: #007acc;
    }

    .top-bar a {
      display: inline-block;
      padding: 10px 20px;
      background: #fff;
      color: #007acc;
      font-weight: bold;
      text-decoration: none;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: background 0.3s;
    }

    .top-bar a:hover {
      background: #e6f0ff;
    }

    .container {
      max-width: 960px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    #conteudo-newsletter {
      font-size: 1rem;
      line-height: 1.6;
      color: #333;
    }

    .mensagem {
      background: #ffe9e9;
      border: 1px solid #e74c3c;
      color: #c0392b;
      padding: 16px;
      border-radius: 8px;
      font-size: 1.1em;
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <div class="top-bar">
    <a href="newsletters.html">‚Üê Voltar para Newsletters</a>
  </div>

  <div class="container">
    <h1 id="titulo-newsletter">Carregando newsletter...</h1>
    <div id="conteudo-newsletter">Aguarde enquanto buscamos o conte√∫do.</div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>

  <!-- Inicializa√ß√£o do Firebase -->
  <script src="js/firebase-init.js"></script>
  <script src="js/functions.js"></script>
  
  <!-- Script principal (deve vir depois) -->
  <script>
    function formatarDataFirestore(valor) {
      if (!valor) return "";

      // Se j√° for string, retorna direto
      if (typeof valor === "string") return valor;

      // Se for Timestamp do Firestore
      if (valor.seconds) {
        const data = new Date(valor.seconds * 1000);
        return data.toLocaleDateString("pt-BR");
      }

      return "";
    }

    window.addEventListener("DOMContentLoaded", () => {
      if (!window.db) {
        console.error("Firebase n√£o foi inicializado corretamente.");
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");

      const tituloEl = document.getElementById("titulo-newsletter");
      const conteudoEl = document.getElementById("conteudo-newsletter");

      if (!id) {
        tituloEl.innerText = "ID n√£o informado";
        conteudoEl.innerHTML = `
        <div class="mensagem">
          Nenhum ID de newsletter foi fornecido na URL.
        </div>`;
        return;
      }

      window.db.collection("newsletters").doc(id).get().then(doc => {
        if (!doc.exists) {
          tituloEl.innerText = "Newsletter n√£o encontrada";
          conteudoEl.innerHTML = `
          <div class="mensagem">
            N√£o foi poss√≠vel localizar esta newsletter.<br>
            Verifique o link ou tente novamente mais tarde.
          </div>`;
          return;
        }

        const d = doc.data();

        // üîπ Remove o t√≠tulo duplicado
        tituloEl.style.display = "none";

        // üîπ Carrega o HTML
        let htmlBase = d.html_conteudo || "<p>Conte√∫do n√£o dispon√≠vel.</p>";

        const blocos = d.blocos || [];

        let htmlBlocos = "";

        // ‚úÖ Monta blocos filtrados por segmento leads
        let segmento = "leads";
        if (blocos.length > 0) {
          blocos.forEach(b => {
            // Filtra por segmento (lead/assinante)
            if (segmento && b.acesso !== "todos" && b.acesso !== segmento) return;

            htmlBlocos += b.html || "";
          });
        }

        let htmlFinal = "";

        if (blocos.length === 0) {
          // ‚úÖ Sem blocos ‚Üí usa apenas o HTML base
          htmlFinal = htmlBase;
        } else {
          // ‚úÖ Com blocos ‚Üí insere no {{blocos}} ou no final
          if (htmlBase.includes("{{blocos}}")) {
            htmlFinal = htmlBase.replace("{{blocos}}", htmlBlocos);
          } else {
            htmlFinal = htmlBase + "\n" + htmlBlocos;
          }
        }

        // ‚úÖ Aplica placeholders reais do destinat√°rio
        htmlFinal = aplicarPlaceholders(htmlFinal, d);

        // üîπ Renderiza
        conteudoEl.innerHTML = htmlFinal;

      }).catch(err => {
        tituloEl.innerText = "Erro ao carregar";
        conteudoEl.innerHTML = `
        <div class="mensagem">
          Ocorreu um erro ao buscar a newsletter: ${err.message}
        </div>`;
      });
    });
  </script>

</body>

</html>